<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Alex Martínez – Artist</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Performance: DNS prefetch for CDNs -->
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com" />
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net" />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
    <style>
      body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin: 0;
        background: linear-gradient(-45deg, #f0f0f0, #fafafa, #fdfdfd, #f0f0f0);
        animation: gradientBG 20s ease infinite;
      }
      @keyframes gradientBG {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /* ===== NAV ===== */
      nav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        height: 70px;
        width: 100%;
        background: transparent;
        z-index: 1000;
        transition:
          background 0.3s ease,
          box-shadow 0.3s ease;
      }
      nav.scrolled {
        background: rgba(255, 255, 255, 0.2);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(8px);
      }
      nav ul {
        display: flex;
        gap: 1rem;
        list-style: none;
        margin: 0;
        padding: 0;
      }
      nav a {
        text-decoration: none;
        color: #111;
        font-weight: 500;
        cursor: pointer;
      }

      /* nav strong {
        color: white; 
        text-shadow: 0 2px 6px black;
      } */

      /* Hamburger (hidden >700px) */
      .nav-toggle {
        display: none;
        width: 42px;
        height: 42px;
        border: 0;
        background: transparent;
        cursor: pointer;
        align-items: center;
        justify-content: center;
      }
      .nav-toggle .bar {
        position: relative;
        display: block;
        width: 22px;
        height: 2px;
        background: #111;
        transition:
          transform 0.25s ease,
          opacity 0.2s ease;
      }
      .nav-toggle .bar + .bar {
        margin-top: 6px;
      }
      nav.open .nav-toggle .bar:nth-child(1) {
        transform: translateY(8px) rotate(45deg);
      }
      nav.open .nav-toggle .bar:nth-child(2) {
        opacity: 0;
      }
      nav.open .nav-toggle .bar:nth-child(3) {
        transform: translateY(-8px) rotate(-45deg);
      }

      /* Tools page layout */
      .tools {
        /* keep your centered page header */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 160px);
        text-align: center;
        padding: 4rem 1rem;
      }

      /* shared width for both grids + their labels */
      .tools-wrap {
        width: min(920px, 100%);
        margin-inline: auto;
      }

      /* section labels aligned to the left edge of the grid */
      .tools-label {
        margin: 2rem 0 0.75rem;
        text-align: left;
        font-weight: 600;
      }
      .tools-label:first-of-type {
        margin-top: 0.5rem;
      } /* space beneath main H2 */

      /* chip-style labels */
      .chip-label {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        color: #333;
        border: 1px solid rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
      }

      .chip-label i {
        font-size: 0.85rem;
        opacity: 0.8;
      }

      .chip-label:hover {
        background: rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
      }

      /* your existing grid, but it now fills the tools-wrap width */
      .tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
        gap: 16px;
        width: 100%;
        margin-top: 0; /* spacing handled by the labels above */
      }

      /* each item is an anchor that is a perfect square */
      .tool {
        position: relative;
        display: block;
        aspect-ratio: 1 / 1; /* perfect square */
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.06);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        text-decoration: none; /* no underline */
        transition:
          transform 0.18s ease,
          box-shadow 0.18s ease;
      }

      .tool:hover {
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.12);
      }

      /* focus for keyboard users */
      .tool:focus-visible {
        outline: 3px solid #e63946;
        outline-offset: 3px;
        border-radius: 14px;
      }

      /* center the img and keep it contained */
      .tool img {
        position: absolute;
        inset: 0;
        width: 70%;
        height: 70%;
        margin: auto;
        object-fit: contain; /* keep logos clean */
        pointer-events: none;
      }

      /* Mobile dropdown */
      @media (max-width: 700px) {
        .nav-toggle {
          display: inline-flex;
        }
        nav ul {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          flex-direction: column;
          gap: 0;
          background: rgba(255, 255, 255, 0.9);
          backdrop-filter: blur(8px);
          border-bottom: 1px solid rgba(0, 0, 0, 0.06);
          max-height: 0;
          overflow: hidden;
          padding: 0 1rem;
          transition: max-height 0.25s ease;
        }
        nav.open ul {
          max-height: 260px;
          padding: 0.5rem 1rem 0.75rem;
        }
        nav ul li {
          padding: 0.25rem 0;
        }
        nav a {
          display: block;
          padding: 0.25rem 0;
          font-size: 0.95rem;
        }
      }

      main {
        padding: 8rem 2rem 2rem;
      }

      /* ===== HERO ===== */
      .hero {
        text-align: center;
        min-height: 80vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 6rem 2rem;
      }
      .hero h1 {
        font-size: clamp(3rem, 8vw, 6rem);
        font-weight: 900;
        color: #111;
        margin: 0;
      }
      .hero h2 {
        font-size: 1.25rem;
        color: #666;
        margin-top: 1rem;
      }

      button,
      .delete-btn {
        background: none;
        border: 2px solid #e63946;
        color: #e63946;
        transition: color 0.3s ease;
      }
      button:hover,
      .delete-btn:hover {
        color: #111;
      }

      .subscribe form {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin-top: 2rem;
        gap: 0.5rem;
        max-width: 500px;
      }
      .subscribe input,
      .subscribe button {
        flex: 1 1 200px;
        min-width: 150px;
      }

      /* Social icons under the hero */
      .socials {
        display: inline-flex;
        gap: 14px;
        align-items: center;
        margin-top: 1rem;
      }

      .social-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        color: #111; /* black icon */
        width: 32px; /* touch target without a visible circle */
        height: 32px;
      }

      .social-link i {
        font-size: 1.4rem;
        line-height: 1;
      }

      .social-link:hover {
        transform: scale(1.06);
      }

      /* ===== ABOUT ===== */
      .about {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        text-align: center;
        min-height: 80vh;
      }
      #about-canvas {
        position: relative;
        width: 400px;
        height: 400px;
        margin: 0 auto;
        overflow: visible;
        z-index: 1;
        opacity: 0;
        transition: opacity 300ms ease;
        will-change: opacity;
      }
      #about-canvas:not(:empty) {
        opacity: 1;
      }
      #about-canvas canvas {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 800px;
        height: 800px;
        transform: translate(-50%, -50%);
        pointer-events: auto;
        z-index: 2;
      }
      @media (prefers-reduced-motion: reduce) {
        #about-canvas {
          transition: none;
          opacity: 1;
        }
      }
      .about-text {
        max-width: 700px;
      }

      /* ===== UPLOAD ===== */
      .upload {
        padding: 1.5rem;
        margin: 2rem auto;
        border: 2px dashed #bbb;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        background: #fff;
        text-align: center;
        cursor: pointer;
        max-width: 400px;
        width: 100%;
      }
      .upload input,
      .upload button {
        margin-top: 0.5rem;
      }

      /* ===== PORTFOLIO ===== */
      .portfolio-wrapper {
        max-width: 1000px;
        margin: 6rem auto 0 auto;
        min-height: 100vh;
      }
      .gallery {
        column-count: 3;
        column-gap: 2rem;
      }
      .gallery-item {
        display: inline-block;
        width: 100%;
        margin-bottom: 1rem;
        position: relative;
        break-inside: avoid;
        opacity: 0;
        transform: translateY(30px);
        animation: fadeInUp 0.6s ease forwards;
        transition:
          transform 0.6s ease,
          opacity 0.6s ease;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .gallery-item img,
      .gallery-item video {
        width: 100%;
        border-radius: 6px;
        display: block;
      }
      .gallery-item video {
        max-height: 500px;
        object-fit: cover;
        cursor: pointer;
      }
      .gallery-item:hover {
        transform: scale(1.03);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
      }
      @media (max-width: 900px) {
        .gallery {
          column-count: 2;
        }
      }

      /* ===== MOBILE: masonry layout with 2 columns ===== */
      @media (max-width: 600px) {
        .gallery {
          column-count: 2;
          column-gap: 1rem;
          padding: 0 1rem;
        }

        .gallery-item {
          margin-bottom: 1rem;
        }

        /* gentle stagger so rows don’t pop all at once */

        .gallery-item:hover {
          transform: none;
          box-shadow: none;
        }

        /* Respect reduced motion on mobile */
        @media (prefers-reduced-motion: reduce) {
          .gallery-item {
            animation: none;
            opacity: 1;
            transform: none;
          }
        }
      }

      @media (pointer: coarse) {
        .gallery-item:hover {
          transform: none;
          box-shadow: none;
        }
      }

      /* Trash button */
      .delete-btn {
        position: absolute;
        top: 6px;
        right: 6px;
        background: none !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        width: auto !important;
        height: auto !important;
        line-height: 1 !important;
        display: flex !important;
        align-items: center;
        justify-content: center;
        color: #000;
        cursor: pointer;
        z-index: 15;
      }
      .gallery-item.admin .delete-btn {
        display: block;
      }

      /* Caption styles */
      .gallery-item .caption {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        color: white;
        padding: 20px 12px 12px;
        font-size: 0.85rem;
        line-height: 1.3;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .gallery-item:hover .caption,
      .gallery-item.show-caption .caption {
        opacity: 1;
      }

      /* Mobile: Always show captions if they exist */
      @media (max-width: 700px) {
        .gallery-item .caption {
          opacity: 1;
          position: static;
          background: rgba(0, 0, 0, 0.8);
          margin-top: 8px;
          padding: 8px;
          border-radius: 4px;
        }
      }

      /* Admin caption editing */
      .caption-edit {
        position: absolute;
        bottom: 8px;
        left: 8px;
        right: 8px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 6px;
        padding: 6px;
        backdrop-filter: blur(8px);
        border: 1px solid rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
        z-index: 5;
        pointer-events: none;
      }

      .gallery-item.admin.editing-caption .caption-edit {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      /* Caption edit button for all screen sizes */
      .caption-edit-btn {
        position: absolute;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
        width: 50%;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        padding: 6px 8px;
        font-size: 0.75rem;
        cursor: pointer;
        z-index: 3;
        display: none;
      }

      .gallery-item.admin .caption-edit-btn {
        display: block;
      }

      /* Mobile specific adjustments */
      @media (max-width: 700px) {
        .caption-edit {
          position: static;
          opacity: 1;
          transform: none;
          margin-top: 8px;
          display: none;
        }

        .gallery-item.admin.editing-caption .caption-edit {
          display: block;
        }
      }

      /* Desktop: Show caption edit in overlay */
      @media (min-width: 701px) {
        .gallery-item.admin.editing-caption .caption-edit {
          opacity: 1;
          transform: translateY(0);
          pointer-events: auto;
        }
      }

      .caption-edit textarea {
        width: 100%;
        min-height: 50px;
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        padding: 6px;
        font-size: 0.8rem;
        resize: vertical;
        background: white;
        font-family: inherit;
      }

      .caption-edit .caption-buttons {
        display: flex;
        gap: 6px;
        margin-top: 6px;
      }

      .caption-edit button {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        font-size: 0.75rem;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .caption-edit .save-btn {
        background: #28a745;
        color: white;
      }

      .caption-edit .save-btn:hover {
        background: #218838;
      }

      .caption-edit .cancel-btn {
        background: #6c757d;
        color: white;
      }

      .caption-edit .cancel-btn:hover {
        background: #5a6268;
      }

      /* ===== LIGHTBOX ===== */
      .lightbox {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease;
        z-index: 10000;
      }
      .lightbox.active {
        opacity: 1;
        visibility: visible;
      }
      .lightbox-content {
        max-width: 90vw;
        max-height: 90vh;
      }
      .lightbox-content img,
      .lightbox-content video {
        max-width: 90vw;
        max-height: 90vh;
        width: auto;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        object-fit: contain;
        display: block;
        margin: auto;
      }
      .lightbox video {
        background: #000;
      }
      .lightbox-close {
        position: fixed;
        top: 20px;
        right: 30px;
        font-size: 2.5rem;
        color: #fff;
        cursor: pointer;
        z-index: 10001;
        text-shadow: 0 0 6px rgba(0, 0, 0, 0.6);
      }
      .lightbox-nav {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        font-size: 3rem;
        color: #fff;
        background: rgba(0, 0, 0, 0.3);
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        z-index: 10001;
      }
      .lightbox-prev {
        left: 30px;
      }
      .lightbox-next {
        right: 30px;
      }
      .lightbox-nav:hover {
        background: rgba(0, 0, 0, 0.6);
      }
      @media (max-width: 600px) {
        .lightbox-close {
          font-size: 2rem;
          top: 12px;
          right: 16px;
        }
        .lightbox-nav {
          font-size: 2rem;
          padding: 0.25rem 0.5rem;
        }
      }

      /* ===== CONTACT / LOGIN ===== */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 80px);
        box-sizing: border-box;
        padding: 0;
      }
      @keyframes fadeSlideIn {
        0% {
          opacity: 0;
          transform: translateY(40px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* HIDE login by default */
      #loginBtn,
      #pillLoginBtn {
        display: none !important;
      }
      /* SHOW login only when you’ve enabled owner mode AND you are NOT authenticated */
      .owner-mode:not(.is-auth) #loginBtn,
      .owner-mode:not(.is-auth) #pillLoginBtn {
        display: inline-block !important;
      }

      /* Password toggle */
      .password-field {
        position: relative;
      }
      .password-field input {
        padding-right: 48px; /* room for the eye */
      }

      /* Stretch the button to the input's height and center the icon */
      .toggle-password {
        position: absolute;
        top: 0;
        bottom: 0; /* <-- centers vertically with flex */
        right: 10px;
        width: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: 0;
        padding: 0;
        color: #666;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent; /* no gray flash on mobile */
      }

      /* Remove the red outline/ring; keep a subtle focus only for keyboard users */
      .toggle-password:focus {
        outline: none;
        box-shadow: none;
      }
      .toggle-password:focus-visible {
        outline: 2px solid #888; /* pick your color or remove entirely */
        outline-offset: 2px;
        border-radius: 6px;
      }

      /* HIDE logout by default */
      #logoutBtn,
      #pillLogoutBtn {
        display: none !important;
      }
      /* SHOW logout only when authenticated */
      .is-auth #logoutBtn,
      .is-auth #pillLogoutBtn {
        display: inline-block !important;
      }

      .login-card,
      .contact-card {
        border: 1px solid #ddd;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        background: #fff;
        width: 100%;
        text-align: center;
        margin-top: 0;
        animation: fadeSlideIn 0.6s ease forwards;
      }
      .login-card {
        max-width: 350px;
      }
      .contact-card {
        max-width: 600px;
      }
      @media (max-width: 600px) {
        .login-card,
        .contact-card {
          padding: 1.5rem;
        }
      }
      .login-card form,
      .contact-card form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      textarea {
        min-height: 120px;
        resize: none;
        overflow: hidden;
      }

      footer {
        text-align: center;
        padding: 1.5rem 1rem;
        font-size: 0.9rem;
        color: #555;
        font-style: italic;
        opacity: 0.8;
        background: transparent;
        margin-top: 4rem;
      }

      /* ===== RESPONSIVE UTIL ===== */
      #about-canvas {
        width: clamp(260px, 60vw, 400px);
        height: clamp(260px, 60vw, 400px);
      }
      #about-canvas canvas {
        width: 200%;
        height: 200%;
      }
      html,
      body {
        overflow-x: hidden;
      }
      @media (max-width: 900px) {
        nav {
          padding: 0.75rem 1rem;
          height: 64px;
        }
        nav ul {
          gap: 0.75rem;
        }
      }
      @media (max-width: 600px) {
        nav {
          padding: 0.5rem 0.75rem;
        }
        main {
          padding-left: 1rem;
          padding-right: 1rem;
          padding-bottom: 7rem; /* Extra space for floating nav */
        }
        .hero {
          padding: 4rem 1rem;
          min-height: 70vh;
        }
        .about-text {
          padding: 0 0.5rem;
          max-width: 90vw;
        }
      }

      /* ===== FLOATING PILL NAVIGATION ===== */
      .floating-nav {
        display: none; /* Hidden by default, shown on mobile */
        position: fixed;
        bottom: env(safe-area-inset-bottom, 24px);
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        pointer-events: none;
      }

      .floating-nav-pill {
        position: relative;
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 28px;
        padding: 8px 12px;
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.1),
          0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        pointer-events: auto;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .floating-nav-pill:hover {
        transform: translateY(-2px);
        box-shadow:
          0 12px 40px rgba(0, 0, 0, 0.15),
          0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .floating-nav-item {
        position: relative;
        display: grid;
        place-items: center;
        width: 44px;
        height: 44px;
        margin: 0 2px;
        border-radius: 50%;
        color: #666;
        font-size: 18px;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 2;
      }

      .floating-nav-item i {
        position: static;
        display: inline-block;
        width: 1.25em;
        text-align: center;
        line-height: 1;
        transition: transform 0.2s ease;
      }

      .floating-nav-item:hover {
        color: #333;
        transform: scale(1.05);
      }

      .floating-nav-item:hover i {
        transform: scale(1.1);
      }

      .floating-nav-item.active {
        color: #fff;
        font-weight: 500;
      }

      .floating-nav-active-bg {
        position: absolute;
        top: 8px;
        left: 0;
        width: 44px;
        height: 44px;
        background: #e63946;
        border-radius: 50%;
        transform: translateX(0);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1;
        box-shadow: 0 2px 8px rgba(230, 57, 70, 0.3);
      }

      .floating-nav-overflow {
        position: relative;
        cursor: pointer;
      }

      .floating-nav-overflow-menu {
        position: absolute;
        bottom: 100%;
        right: 0;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        opacity: 0;
        transform: translateY(8px) scale(0.9);
        transition: all 0.2s ease;
        pointer-events: none;
        min-width: 120px;
      }

      .floating-nav-overflow-menu.show {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
      }

      .floating-nav-overflow-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        margin: 2px 0;
        border-radius: 8px;
        color: #666;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .floating-nav-overflow-item:hover {
        background: rgba(230, 57, 70, 0.1);
        color: #e63946;
      }

      .floating-nav-overflow-item i {
        width: 16px;
        font-size: 14px;
      }

      /* Show floating nav on mobile and hide web navbar */
      @media (max-width: 700px) {
        .floating-nav {
          display: block;
        }
        nav {
          display: none;
        }
      }

      /* Respect reduced motion */
      @media (prefers-reduced-motion: reduce) {
        .floating-nav-pill,
        .floating-nav-item,
        .floating-nav-active-bg,
        .floating-nav-overflow-menu {
          transition: none;
        }
      }
    </style>
  </head>
  <body>
    <nav>
      <!-- <strong>Alex Martínez</strong> -->

      <!-- Hamburger (mobile) -->
      <button
        class="nav-toggle"
        aria-expanded="false"
        aria-controls="primary-menu"
        aria-label="Menu"
      >
        <span class="bar"></span><span class="bar"></span
        ><span class="bar"></span>
      </button>

      <ul id="primary-menu">
        <li><a onclick="loadPage('home')">Home</a></li>
        <li><a onclick="loadPage('portfolio')">Portfolio</a></li>
        <li><a onclick="loadPage('about')">About</a></li>
        <li><a onclick="loadPage('tools')">Tools + Tech</a></li>
        <!-- NEW -->
        <li><a onclick="loadPage('contact')">Contact</a></li>
        <li>
          <a id="loginBtn" onclick="loadPage('login')">Login</a>
          <a id="logoutBtn" onclick="logout()" style="display: none">Logout</a>
        </li>
      </ul>
    </nav>

    <main id="content"></main>

    <footer><p>Est. MCMLXXXIX</p></footer>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox">
      <span class="lightbox-close">&times;</span>
      <span class="lightbox-nav lightbox-prev">&#10094;</span>
      <div class="lightbox-content"></div>
      <span class="lightbox-nav lightbox-next">&#10095;</span>
    </div>

    <!-- Floating Mobile Navigation -->
    <div class="floating-nav">
      <div class="floating-nav-pill">
        <div class="floating-nav-active-bg"></div>
        <a
          class="floating-nav-item"
          onclick="loadPage('home')"
          data-page="home"
        >
          <i class="fas fa-home fa-fw"></i>
        </a>
        <a
          class="floating-nav-item"
          onclick="loadPage('portfolio')"
          data-page="portfolio"
        >
          <i class="fas fa-th-large fa-fw"></i>
        </a>
        <a
          class="floating-nav-item"
          onclick="loadPage('about')"
          data-page="about"
        >
          <i class="fas fa-user fa-fw"></i>
        </a>
        <a
          class="floating-nav-item"
          onclick="loadPage('tools')"
          data-page="tools"
        >
          <i class="fa-solid fa-microchip fa-fw"></i>
        </a>
        <div class="floating-nav-overflow floating-nav-item">
          <i class="fas fa-ellipsis-h fa-fw"></i>
          <div class="floating-nav-overflow-menu">
            <a
              class="floating-nav-overflow-item"
              onclick="loadPage('contact')"
              data-page="contact"
            >
              <i class="fas fa-envelope"></i>
              <span>Contact</span>
            </a>
            <a
              class="floating-nav-overflow-item"
              id="pillLoginBtn"
              onclick="loadPage('login')"
              data-page="login"
            >
              <i class="fas fa-sign-in-alt"></i>
              <span>Login</span>
            </a>
            <a
              class="floating-nav-overflow-item"
              id="pillLogoutBtn"
              onclick="logout()"
              style="display: none"
            >
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Initialize token from localStorage
        let token = localStorage.getItem("adminToken");

        // NEW: owner mode flag
        let ownerMode = localStorage.getItem("ownerMode") === "1";

        // NEW: enable owner mode via secret query ?admin=1
        const params = new URLSearchParams(location.search);
        if (params.get("admin") === "1") {
          ownerMode = true;
          localStorage.setItem("ownerMode", "1");
          params.delete("admin");
          history.replaceState(
            {},
            "",
            location.pathname +
              (params.toString() ? "?" + params : "") +
              location.hash,
          );
        }

        // Toggle owner mode with Cmd+Shift+A on Mac (also supports Alt+Shift+A)
        window.addEventListener("keydown", (e) => {
          const keyA = e.key && e.key.toLowerCase() === "a";
          const cmdShiftA = e.metaKey && e.shiftKey && keyA; // Cmd = meta on Mac
          const altShiftA = e.altKey && e.shiftKey && keyA; // optional backup

          if (cmdShiftA || altShiftA) {
            e.preventDefault(); // try to stop the browser's own shortcut
            ownerMode = !ownerMode;
            localStorage.setItem("ownerMode", ownerMode ? "1" : "0");
            updateNavigation();
          }
        });

        const content = document.getElementById("content");
        const lightbox = document.getElementById("lightbox");
        const lightboxContent = lightbox.querySelector(".lightbox-content");
        const closeBtn = lightbox.querySelector(".lightbox-close");
        const prevBtn = lightbox.querySelector(".lightbox-prev");
        const nextBtn = lightbox.querySelector(".lightbox-next");

        let currentIndex = 0;
        let mediaItems = [];

        const nav = document.querySelector("nav");
        const main = document.querySelector("main");
        const toggleBtn = document.querySelector(".nav-toggle");

        /* ===== Hamburger logic ===== */
        function setMenu(open) {
          nav.classList.toggle("open", open);
          toggleBtn.setAttribute("aria-expanded", open ? "true" : "false");
          adjustMainPadding();
        }
        toggleBtn.addEventListener("click", () =>
          setMenu(!nav.classList.contains("open")),
        );
        function closeMenuOnLinkClick() {
          document
            .querySelectorAll("nav a")
            .forEach((a) => a.addEventListener("click", () => setMenu(false)));
        }

        /* ===== Dynamic Library Loading ===== */
        let gsapLoaded = false;
        let pixiLoaded = false;

        async function loadGSAP() {
          if (gsapLoaded || window.gsap) return;
          return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src =
              "https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js";
            script.onload = () => {
              gsapLoaded = true;
              resolve();
            };
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        async function loadPIXI() {
          if (pixiLoaded || window.PIXI) return;
          return new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src =
              "https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.4/pixi.min.js";
            script.onload = () => {
              pixiLoaded = true;
              resolve();
            };
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        /* ===== About PIXI ===== */
        let aboutPixiApp = null;
        async function initWavyImage(imageUrl) {
          // Load PIXI and GSAP dynamically only when needed
          await Promise.all([loadPIXI(), loadGSAP()]);

          if (aboutPixiApp) {
            aboutPixiApp.destroy(true, {
              children: true,
              texture: true,
              baseTexture: true,
            });
            aboutPixiApp = null;
          }
          const visibleSize = 400,
            canvasSize = 800;

          aboutPixiApp = new PIXI.Application({
            width: canvasSize,
            height: canvasSize,
            backgroundAlpha: 0,
            antialias: true,
            autoDensity: true,
            resolution: window.devicePixelRatio || 3,
            autoStart: false,
          });

          const view = aboutPixiApp.view;
          view.style.width = "200%";
          view.style.height = "200%";
          view.style.opacity = "0";

          const container = new PIXI.Container();
          aboutPixiApp.stage.addChild(container);

          const img = PIXI.Sprite.from(imageUrl);
          img.anchor.set(0.5);
          img.x = canvasSize / 2;
          img.y = canvasSize / 2;
          img.width = visibleSize;
          img.height = visibleSize;
          container.addChild(img);

          const res = aboutPixiApp.renderer.resolution;
          const feather = 2;
          const maskCanvas = document.createElement("canvas");
          maskCanvas.width = canvasSize * res;
          maskCanvas.height = canvasSize * res;
          const ctx = maskCanvas.getContext("2d");
          const cx = (canvasSize / 2) * res,
            cy = (canvasSize / 2) * res,
            r = (visibleSize / 2) * res;
          const grd = ctx.createRadialGradient(
            cx,
            cy,
            r - feather * res,
            cx,
            cy,
            r,
          );
          grd.addColorStop(0, "rgba(255,255,255,1)");
          grd.addColorStop(1, "rgba(255,255,255,0)");
          ctx.fillStyle = grd;
          ctx.beginPath();
          ctx.arc(cx, cy, r, 0, Math.PI * 2);
          ctx.fill();

          const maskSprite = PIXI.Sprite.from(maskCanvas);
          maskSprite.anchor.set(0.5);
          maskSprite.x = canvasSize / 2;
          maskSprite.y = canvasSize / 2;
          maskSprite.scale.set(1 / res);
          container.addChild(maskSprite);
          maskSprite.renderable = false;
          container.mask = maskSprite;

          const displacementSprite = PIXI.Sprite.from("/noise.jpeg");
          displacementSprite.texture.baseTexture.wrapMode =
            PIXI.WRAP_MODES.REPEAT;
          displacementSprite.width = canvasSize;
          displacementSprite.height = canvasSize;
          displacementSprite.alpha = 0;
          aboutPixiApp.stage.addChild(displacementSprite);

          const displacementFilter = new PIXI.filters.DisplacementFilter(
            displacementSprite,
          );
          displacementFilter.padding = 200;
          displacementFilter.autoFit = false;
          container.filterArea = new PIXI.Rectangle(
            0,
            0,
            canvasSize,
            canvasSize,
          );
          container.filters = [displacementFilter];
          displacementFilter.scale.set(60);

          let t = 0;
          aboutPixiApp.ticker.add(() => {
            t += 0.01;
            displacementSprite.x = Math.sin(t) * 60;
            displacementSprite.y = Math.cos(t) * 60;
          });

          view.addEventListener("mouseenter", () => {
            gsap.to(displacementFilter.scale, {
              x: 0,
              y: 0,
              duration: 1,
              ease: "power2.out",
            });
          });
          view.addEventListener("mouseleave", () => {
            gsap.to(displacementFilter.scale, {
              x: 60,
              y: 60,
              duration: 1,
              ease: "power3.out",
            });
          });

          const waitTexture = (tex) =>
            tex.valid
              ? Promise.resolve()
              : new Promise((res) => tex.once("update", res));
          Promise.all([
            waitTexture(img.texture),
            waitTexture(displacementSprite.texture),
          ]).then(() => {
            img.width = visibleSize;
            img.height = visibleSize;
            aboutPixiApp.render();
            const holder = document.getElementById("about-canvas");
            holder.innerHTML = "";
            holder.appendChild(view);
            requestAnimationFrame(() => {
              view.style.opacity = "1";
              aboutPixiApp.start();
            });
          });
        }

        /* ===== Layout helpers ===== */
        function adjustMainPadding() {
          const navHeight = nav.offsetHeight;
          main.style.paddingTop = navHeight + 30 + "px";
        }
        adjustMainPadding();
        window.addEventListener("resize", adjustMainPadding);

        // replace handlePortfolioScroll with a generic name
        let ticking = false;
        function handleScroll() {
          if (!ticking) {
            requestAnimationFrame(() => {
              if (window.scrollY > 50) nav.classList.add("scrolled");
              else nav.classList.remove("scrolled");
              ticking = false;
            });
            ticking = true;
          }
        }

        /* ===== Portfolio shuffle (desktop only) ===== */
        let shuffleInterval;
        function shuffleGallery() {
          const gallery = document.querySelector(".gallery");
          if (!gallery) return;
          const items = Array.from(gallery.children);
          const firstRects = items.map((el) => el.getBoundingClientRect());
          for (let i = items.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [items[i], items[j]] = [items[j], items[i]];
          }
          items.forEach((el) => gallery.appendChild(el));
          const lastRects = items.map((el) => el.getBoundingClientRect());
          items.forEach((el, i) => {
            const dx = firstRects[i].left - lastRects[i].left;
            const dy = firstRects[i].top - lastRects[i].top;
            el.style.transform = `translate(${dx}px, ${dy}px)`;
            el.style.transition = "transform 0s";
            requestAnimationFrame(() => {
              el.style.transform = "translate(0,0)";
              el.style.transition = "transform 0.8s ease";
            });
          });
        }

        /* ===== Router ===== */
        async function loadPage(page) {
          setMenu(false);
          if (page === "home") {
            content.innerHTML = `
            <section class="hero">
              <h1>Alex Martínez</h1>
              <h2 id="subtitle"></h2>
              <div class="subscribe">
                <form id="subscribeForm">
                  <input type="text" placeholder="Your name" required>
                  <input type="email" placeholder="Your email" required>
                  <button>Subscribe</button>
                </form>
              </div>

              <div class="socials">
                <a class="social-link" href="https://instagram.com/debtfortunes"
                   target="_blank" rel="noopener" aria-label="Instagram">
                  <i class="fab fa-instagram"></i>
                </a>
                <a class="social-link" href="https://www.linkedin.com/in/alexanderjustinmartinez/"
                   target="_blank" rel="noopener" aria-label="LinkedIn">
                  <i class="fab fa-linkedin-in"></i>
                </a>
                <a class="social-link" href="https://github.com/AlexJMartinez"
                   target="_blank" rel="noopener" aria-label="GitHub">
                  <i class="fab fa-github"></i>
                </a>
              </div>
            </section>`;
            closeMenuOnLinkClick();
            startTypingEffect("subtitle", "Minimalist Abstract Expression");

            // Add subscribe form event listener
            const subscribeForm = document.getElementById("subscribeForm");
            if (subscribeForm) {
              subscribeForm.addEventListener("submit", async (e) => {
                e.preventDefault();

                const formData = new FormData(subscribeForm);
                const name = subscribeForm
                  .querySelector('input[type="text"]')
                  .value.trim();
                const email = subscribeForm
                  .querySelector('input[type="email"]')
                  .value.trim();

                if (!name || !email) {
                  alert("Please fill in both name and email.");
                  return;
                }

                const button = subscribeForm.querySelector("button");
                const originalText = button.textContent;
                button.textContent = "Subscribing...";
                button.disabled = true;

                try {
                  const response = await fetch("/subscribe", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ name, email }),
                  });

                  const result = await response.json();

                  if (result.success) {
                    alert("🎉 " + result.message);
                    subscribeForm.reset();
                  } else {
                    alert("Error: " + (result.error || "Failed to subscribe"));
                  }
                } catch (error) {
                  console.error("Subscribe error:", error);
                  alert("Failed to subscribe. Please try again later.");
                } finally {
                  button.textContent = originalText;
                  button.disabled = false;
                }
              });
            }
          }

          if (page === "about") {
            const res = await fetch("/about-data");
            const data = await res.json();
            content.innerHTML = `
              <section class="about">
                <div id="about-canvas"></div>
                <div class="about-text">
                  <h2>About The Artist</h2>
                  <p>"It's no measure of health to be well adjusted to a profoundly sick society" - Jiddu Krishnamurti</p>
                </div>
              </section>
              ${token ? `<div class="upload"><h3>Update About</h3><input type="file" id="aboutUpload"></div>` : ""}`;
            closeMenuOnLinkClick();
            initWavyImage(data.image || "https://picsum.photos/500");

            if (token) {
              document
                .getElementById("aboutUpload")
                .addEventListener("change", async (e) => {
                  const file = e.target.files[0];
                  if (!file) return;
                  const fd = new FormData();
                  fd.append("file", file);
                  await fetch("/upload/about", {
                    method: "POST",
                    headers: { Authorization: "Bearer " + token },
                    body: fd,
                  });
                  loadPage("about");
                });
            }
          }

          if (page === "tools") {
            content.innerHTML = `
              <section class="tools">
                <h2>Tools + Tech</h2>
                <div class="tools-wrap">
                <!-- GRID 1 -->
                <h3 class="tools-label chip-label"><i class="fas fa-palette"></i> Studio</h3>
                <div class="tools-grid">
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Ableton.png" alt="HTML" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Adobe.jpeg" alt="CSS" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Avid.jpg" alt="JavaScript" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Blender.png" alt="GSAP" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Chat.png" alt="PixiJS" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Cycling.png" alt="Pico.css" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Davinci.jpeg" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Javascript.png" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Logic.jpeg" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Mediapipe.png" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/P5.png" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Python.jpeg" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Touch_OSC.png" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/TouchDesigner.png" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Hex.jpeg" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Gimp.jpeg" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Inkscape.jpeg" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/VS_code.jpeg" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Figma.jpeg" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Runway.png" alt="Font Awesome" loading="lazy">
                  </a>
                  <a class="tool" href="" target="_blank" rel="noopener">
                    <img src="/logos/Midjourney.png" alt="Font Awesome" loading="lazy">
                  </a>
                  <!-- Add more tiles by repeating the <a class="tool"> … </a> block -->
                </div>
                <!-- GRID 2 -->
                  <h3 class="tools-label chip-label"><i class="fas fa-briefcase"></i> Ops</h3>
                  <div class="tools-grid">
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Slack.png" alt="Slack" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Jira.jpeg" alt="Jira" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Confluence.jpeg" alt="Confluence" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Asana.png" alt="Asana" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Notion.png" alt="Notion" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Monday.jpeg" alt="Google Workspace" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Office.png" alt="Microsoft 365" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Smartsheet.png" alt="Salesforce" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Freshdesk.png" alt="Salesforce" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos/Github.png" alt="Font Awesome" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Zapier.png" alt="Font Awesome" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/n8n.png" alt="Font Awesome" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Make.png" alt="Font Awesome" loading="lazy">
                    </a>
                    <a class="tool" href="" target="_blank" rel="noopener">
                      <img src="/logos_corp/Google.png" alt="Font Awesome" loading="lazy">
                    </a>
                    <!-- add more corporate apps as needed -->
                  </div>
                </div>
              </section>`;
            closeMenuOnLinkClick();
          }

          if (page === "portfolio") {
            const res = await fetch("/portfolio-images");
            const gallery = await res.json();
            content.innerHTML = `
              <section class="portfolio-wrapper">
                <div class="gallery">
                  ${gallery
                    .map((item) => {
                      const ext = item.url.split(".").pop().toLowerCase();
                      const isVideo = ["mp4", "webm", "ogg", "mov"].includes(
                        ext,
                      );
                      return `
                      <div class="gallery-item ${token ? "admin" : ""}" data-id="${item.id}">
                        ${
                          isVideo
                            ? `<video src="${item.url}" muted loop playsinline preload="none" loading="lazy"></video>`
                            : `<img src="${item.url}" alt="Artwork" loading="lazy" decoding="async">`
                        }
                        ${item.caption ? `<div class="caption"></div>` : ""}
                        ${
                          token
                            ? `
                          <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                          <button class="caption-edit-btn">Edit Caption</button>
                          <div class="caption-edit">
                            <textarea placeholder="Add a caption..." maxlength="500"></textarea>
                            <div class="caption-buttons">
                              <button class="save-btn">Save</button>
                              <button class="cancel-btn">Cancel</button>
                            </div>
                          </div>
                        `
                            : ""
                        }
                      </div>`;
                    })
                    .join("")}
                </div>
                ${token ? `<div class="upload"><h3>Upload New Work</h3><input type="file" id="portfolioUpload"></div>` : ""}
              </section>`;
            closeMenuOnLinkClick();

            // Safely set caption text content and textarea values to prevent XSS
            gallery.forEach((item, index) => {
              const galleryItem = document.querySelector(
                `[data-id="${item.id}"]`,
              );
              if (galleryItem && item.caption) {
                const captionEl = galleryItem.querySelector(".caption");
                if (captionEl) {
                  captionEl.textContent = item.caption; // Safe text setting
                }
                const textarea = galleryItem.querySelector(
                  ".caption-edit textarea",
                );
                if (textarea) {
                  textarea.value = item.caption; // Safe value setting
                  textarea.setAttribute("data-original-caption", item.caption);
                }
              }
            });

            const isAdmin = !!token; // Check if admin is logged in
            const shouldShuffle =
              window.matchMedia("(pointer: fine) and (min-width: 601px)")
                .matches && !isAdmin; // Disable shuffle when admin is logged in
            if (shuffleInterval) clearInterval(shuffleInterval);
            if (shouldShuffle)
              shuffleInterval = setInterval(shuffleGallery, 10000);

            mediaItems = Array.from(
              document.querySelectorAll(
                ".gallery-item img, .gallery-item video",
              ),
            );
            // Setup Intersection Observer for lazy video loading
            const videoObserver = new IntersectionObserver(
              (entries) => {
                entries.forEach((entry) => {
                  if (entry.isIntersecting) {
                    const vid = entry.target;
                    vid.muted = true;
                    vid.loop = true;
                    vid.playsInline = true;
                    vid.load(); // Start loading the video
                    vid.addEventListener(
                      "loadeddata",
                      () => {
                        vid.play().catch(() => {});
                      },
                      { once: true },
                    );
                    videoObserver.unobserve(vid); // Stop observing once loaded
                  }
                });
              },
              {
                rootMargin: "50px", // Start loading 50px before the video enters viewport
              },
            );

            document.querySelectorAll(".gallery-item video").forEach((vid) => {
              videoObserver.observe(vid);
            });
            mediaItems.forEach((el, idx) =>
              el.addEventListener("click", () => {
                currentIndex = idx;
                openLightbox(el);
              }),
            );

            if (token) {
              document
                .querySelectorAll(".gallery-item.admin")
                .forEach((item) => {
                  const btn = item.querySelector(".delete-btn");
                  const media = item.querySelector("img, video");
                  if (media && btn) {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    function runCheck() {
                      setAdaptiveIconColor(media, btn, canvas, ctx);
                    }
                    if (media.tagName === "IMG") {
                      media.addEventListener("load", runCheck);
                      if (media.complete) runCheck();
                    } else {
                      media.addEventListener("loadeddata", runCheck);
                      media.addEventListener("timeupdate", () => {
                        if (media.currentTime % 1 < 0.1) runCheck();
                      });
                      if (media.readyState >= 2) runCheck();
                    }
                  }
                });

              document
                .getElementById("portfolioUpload")
                ?.addEventListener("change", async (e) => {
                  const file = e.target.files[0];
                  if (!file) return;
                  try {
                    const fd = new FormData();
                    fd.append("file", file);
                    const response = await fetch("/upload/portfolio", {
                      method: "POST",
                      headers: { Authorization: "Bearer " + token },
                      body: fd,
                    });

                    const result = await response.json();
                    if (response.ok) {
                      loadPage("portfolio");
                    } else {
                      alert(
                        "❌ Upload failed: " +
                          (result.error || "Unknown error"),
                      );
                      if (response.status === 401) {
                        localStorage.removeItem("adminToken");
                        token = null;
                        loadPage("login");
                      }
                    }
                  } catch (error) {
                    console.error("Upload error:", error);
                    alert("❌ Upload failed. Please try again.");
                  }
                });

              document
                .querySelectorAll(".gallery-item .delete-btn")
                .forEach((btn) => {
                  btn.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    const id = btn.parentElement.dataset.id;
                    try {
                      const response = await fetch("/portfolio/" + id, {
                        method: "DELETE",
                        headers: { Authorization: "Bearer " + token },
                      });

                      const result = await response.json();
                      if (response.ok) {
                        loadPage("portfolio");
                      } else {
                        alert(
                          "❌ Delete failed: " +
                            (result.error || "Unknown error"),
                        );
                        if (response.status === 401) {
                          localStorage.removeItem("adminToken");
                          token = null;
                          loadPage("login");
                        }
                      }
                    } catch (error) {
                      console.error("Delete error:", error);
                      alert("❌ Delete failed. Please try again.");
                    }
                  });
                });

              // Caption editing functionality
              document
                .querySelectorAll(".caption-edit .save-btn")
                .forEach((saveBtn) => {
                  saveBtn.addEventListener("click", async (e) => {
                    e.stopPropagation();
                    const captionEdit = saveBtn.closest(".caption-edit");
                    const textarea = captionEdit.querySelector("textarea");
                    const galleryItem = captionEdit.closest(".gallery-item");
                    const id = galleryItem.dataset.id;
                    const caption = textarea.value.trim();

                    try {
                      const response = await fetch(`/portfolio/${id}/caption`, {
                        method: "PATCH",
                        headers: {
                          Authorization: "Bearer " + token,
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ caption }),
                      });
                      const result = await response.json();
                      if (result.success) {
                        // Use the sanitized caption from server response
                        const sanitizedCaption = result.caption || "";

                        // Update caption display safely without reload
                        const captionElement =
                          galleryItem.querySelector(".caption");
                        if (sanitizedCaption) {
                          if (!captionElement) {
                            const newCaption = document.createElement("div");
                            newCaption.className = "caption";
                            galleryItem.appendChild(newCaption);
                          }
                          galleryItem.querySelector(".caption").textContent =
                            sanitizedCaption;
                        } else if (captionElement) {
                          captionElement.remove();
                        }

                        // Update textarea original value to sanitized version
                        textarea.setAttribute(
                          "data-original-caption",
                          sanitizedCaption,
                        );
                        textarea.value = sanitizedCaption;
                        galleryItem.classList.remove("editing-caption");
                      } else {
                        alert(
                          "❌ Caption update failed: " +
                            (result.error || "Unknown error"),
                        );
                        if (response.status === 401) {
                          localStorage.removeItem("adminToken");
                          token = null;
                          loadPage("login");
                        }
                      }
                    } catch (error) {
                      console.error("Caption update error:", error);
                      alert("❌ Caption update failed. Please try again.");
                    }
                  });
                });

              document
                .querySelectorAll(".caption-edit .cancel-btn")
                .forEach((cancelBtn) => {
                  cancelBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const captionEdit = cancelBtn.closest(".caption-edit");
                    const textarea = captionEdit.querySelector("textarea");
                    const galleryItem = captionEdit.closest(".gallery-item");

                    // Reset to original caption from data attribute
                    textarea.value =
                      textarea.getAttribute("data-original-caption") || "";
                    galleryItem.classList.remove("editing-caption");
                  });
                });

              // Mobile caption edit button functionality
              document
                .querySelectorAll(".caption-edit-btn")
                .forEach((editBtn) => {
                  editBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const galleryItem = editBtn.closest(".gallery-item");
                    galleryItem.classList.toggle("editing-caption");
                  });
                });

              setTimeout(() => {
                document
                  .querySelectorAll(".gallery-item.admin")
                  .forEach((item) => {
                    const btn = item.querySelector(".delete-btn");
                    const media = item.querySelector("img, video");
                    if (media && btn) {
                      const canvas = document.createElement("canvas");
                      const ctx = canvas.getContext("2d");
                      setAdaptiveIconColor(media, btn, canvas, ctx);
                    }
                  });
              }, 500);
            }

            document.querySelectorAll(".gallery-item").forEach((item, i) => {
              item.style.animationDelay = `${i * 0.1}s`;
            });
          }

          if (page === "contact") {
            content.innerHTML = `
              <div class="login-container">
                <div class="contact-card">
                  <h2 style="text-align:center;">Contact</h2>
                  <form id="contactForm">
                    <input type="text" name="name" placeholder="Your name">
                    <input type="email" name="email" placeholder="Your email">
                    <textarea name="message" placeholder="Message"></textarea>
                    <button type="submit">Send</button>
                  </form>
                </div>
              </div>`;
            closeMenuOnLinkClick();
            document
              .getElementById("contactForm")
              .addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                try {
                  const res = await fetch("/contact", {
                    method: "POST",
                    body: formData,
                  });

                  const data = await res.json();
                  if (res.ok) {
                    alert("✅ " + (data.message || "Message sent!"));
                    e.target.reset();
                  } else {
                    const errorMsg = data.errors
                      ? data.errors.map((err) => err.msg).join(", ")
                      : data.error || "Failed to send message";
                    alert("❌ " + errorMsg);
                  }
                } catch (error) {
                  console.error("Contact error:", error);
                  alert("i�� Network error. Please try again.");
                }
              });
          }

          if (page === "login") {
            content.innerHTML = `
            <div class="login-container">
              <div class="login-card">
                <h2>Login</h2>
                <form id="loginForm">
                  <input id="user" placeholder="Username" autocomplete="username">
                  <div class="password-field">
                    <input id="pass" type="password" placeholder="Password" autocomplete="current-password">
                    <button type="button" class="toggle-password" aria-label="Show password" aria-pressed="false">
                      <i class="fa-regular fa-eye"></i>
                    </button>
                  </div>
                  <button>Login</button>
                </form>
              </div>
            </div>`;
            closeMenuOnLinkClick();
            document
              .getElementById("loginForm")
              .addEventListener("submit", async (e) => {
                e.preventDefault();
                const username = document.getElementById("user").value;
                const password = document.getElementById("pass").value;

                try {
                  const response = await fetch("/login", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ username, password }),
                  });

                  const data = await response.json();

                  if (response.ok) {
                    token = data.token;
                    localStorage.setItem("adminToken", token);
                    updateNavigation();
                    alert("✅ Login successful");
                    loadPage("home");
                  } else {
                    alert("❌ " + (data.error || "Login failed"));
                  }
                } catch (error) {
                  console.error("Login error:", error);
                  alert("❌ Network error. Please try again.");
                }
              });
            const passInput = document.getElementById("pass");
            const toggleBtn = document.querySelector(".toggle-password");

            toggleBtn?.addEventListener("click", () => {
              const showing = passInput.type === "text";
              passInput.type = showing ? "password" : "text";
              toggleBtn.setAttribute("aria-pressed", (!showing).toString());
              toggleBtn.setAttribute(
                "aria-label",
                showing ? "Show password" : "Hide password",
              );
              toggleBtn.innerHTML = showing
                ? '<i class="fa-regular fa-eye"></i>'
                : '<i class="fa-regular fa-eye-slash"></i>';
            });
          }
        }

        /* ===== Authentication Functions ===== */
        function logout() {
          token = null;
          localStorage.removeItem("adminToken");

          // Hide Login again by default until you hit the admin shortcut
          ownerMode = false;
          localStorage.removeItem("ownerMode");

          updateNavigation();
          const currentPage = getCurrentPage();
          loadPage(currentPage || "home");
          alert("✅ Logged out successfully");
        }

        function getCurrentPage() {
          // Determine current page based on content
          const content = document.getElementById("content");
          if (content.querySelector(".hero")) return "home";
          if (content.querySelector(".about")) return "about";
          if (content.querySelector(".portfolio-wrapper")) return "portfolio";
          if (content.querySelector(".tools")) return "tools";
          if (content.querySelector(".contact-card")) return "contact";
          if (content.querySelector(".login-card")) return "login";
          return "home"; // fallback
        }

        function updateNavigation() {
          const loginBtn = document.getElementById("loginBtn");
          const logoutBtn = document.getElementById("logoutBtn");
          const pillLoginBtn = document.getElementById("pillLoginBtn");
          const pillLogoutBtn = document.getElementById("pillLogoutBtn");

          // reflect state on <body>
          document.body.classList.toggle("owner-mode", ownerMode);
          document.body.classList.toggle("is-auth", !!token);

          const showLogin = ownerMode && !token; // only you + not logged in
          const showLogout = !!token; // logged in

          if (loginBtn) loginBtn.style.display = showLogin ? "block" : "none";
          if (pillLoginBtn)
            pillLoginBtn.style.display = showLogin ? "block" : "none";

          if (logoutBtn)
            logoutBtn.style.display = showLogout ? "block" : "none";
          if (pillLogoutBtn)
            pillLogoutBtn.style.display = showLogout ? "block" : "none";
        }

        /* ===== Typing effect ===== */
        function startTypingEffect(elementId, text, speed = 100) {
          const el = document.getElementById(elementId);
          if (!el) return;
          el.textContent = "";
          let i = 0;
          (function typeWriter() {
            if (i < text.length) {
              el.textContent += text.charAt(i++);
              setTimeout(typeWriter, speed);
            }
          })();
        }

        /* ===== Adaptive icon color ===== */
        function setAdaptiveIconColor(media, btn, canvas, ctx) {
          const size = 8;
          canvas.width = size;
          canvas.height = size;
          try {
            ctx.drawImage(media, 0, 0, size, size);
            const d = ctx.getImageData(0, 0, size, size).data;
            let total = 0,
              count = 0;
            for (let i = 0; i < d.length; i += 4) {
              const r = d[i],
                g = d[i + 1],
                b = d[i + 2];
              total += (r * 299 + g * 587 + b * 114) / 1000;
              count++;
            }
            const avg = total / count;
            const color = avg < 128 ? "#fff" : "#000";
            const shadow =
              avg < 128
                ? "0 0 6px rgba(0,0,0,0.8)"
                : "0 0 6px rgba(255,255,255,0.8)";
            if (btn) {
              btn.style.color = color;
              btn.style.textShadow = shadow;
            }
            // Close button always stays white - removed dynamic color change
          } catch (e) {
            /* cross-origin media may block drawImage */
          }
        }

        /* ===== Lightbox ===== */
        function openLightbox(el) {
          lightboxContent.innerHTML = "";
          let media;
          if (el.tagName === "VIDEO") {
            media = document.createElement("video");
            media.src = el.src;
            media.controls = true;
            media.autoplay = true;
            media.playsInline = true;
            media.muted = false;
          } else {
            media = document.createElement("img");
            media.src = el.src;
          }
          lightboxContent.appendChild(media);
          lightbox.classList.add("active");

          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const runCheck = () => setAdaptiveIconColor(media, null, canvas, ctx);
          if (media.tagName === "IMG") {
            media.addEventListener("load", runCheck);
            if (media.complete) runCheck();
          } else {
            media.addEventListener("loadeddata", runCheck);
            if (media.readyState >= 2) runCheck();
          }
        }

        closeBtn.addEventListener("click", () => {
          lightbox.classList.remove("active");
          lightboxContent.innerHTML = "";
        });
        prevBtn.addEventListener("click", () => {
          if (mediaItems.length) {
            currentIndex =
              (currentIndex - 1 + mediaItems.length) % mediaItems.length;
            openLightbox(mediaItems[currentIndex]);
          }
        });
        nextBtn.addEventListener("click", () => {
          if (mediaItems.length) {
            currentIndex = (currentIndex + 1) % mediaItems.length;
            openLightbox(mediaItems[currentIndex]);
          }
        });

        /* ===== Touch/Swipe Support for Lightbox ===== */
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;

        function handleTouchStart(e) {
          touchStartX = e.changedTouches[0].screenX;
          touchStartY = e.changedTouches[0].screenY;
        }

        function handleTouchEnd(e) {
          touchEndX = e.changedTouches[0].screenX;
          touchEndY = e.changedTouches[0].screenY;
          handleSwipe();
        }

        function handleSwipe() {
          const swipeThreshold = 50; // Minimum distance for swipe
          const swipeRestraint = 100; // Maximum vertical movement allowed
          const deltaX = touchEndX - touchStartX;
          const deltaY = Math.abs(touchEndY - touchStartY);

          // Only trigger swipe if horizontal movement is significant and vertical movement is minimal
          if (
            Math.abs(deltaX) >= swipeThreshold &&
            deltaY <= swipeRestraint &&
            mediaItems.length > 1
          ) {
            if (deltaX > 0) {
              // Swipe right - go to previous image
              currentIndex =
                (currentIndex - 1 + mediaItems.length) % mediaItems.length;
              openLightbox(mediaItems[currentIndex]);
            } else {
              // Swipe left - go to next image
              currentIndex = (currentIndex + 1) % mediaItems.length;
              openLightbox(mediaItems[currentIndex]);
            }
          }
        }

        // Add touch event listeners to lightbox
        lightbox.addEventListener("touchstart", handleTouchStart, {
          passive: true,
        });
        lightbox.addEventListener("touchend", handleTouchEnd, {
          passive: true,
        });
        document.addEventListener("keydown", (e) => {
          if (!lightbox.classList.contains("active")) return;
          if (e.key === "Escape") {
            lightbox.classList.remove("active");
            lightboxContent.innerHTML = "";
          }
          if (e.key === "ArrowLeft") {
            currentIndex =
              (currentIndex - 1 + mediaItems.length) % mediaItems.length;
            openLightbox(mediaItems[currentIndex]);
          }
          if (e.key === "ArrowRight") {
            currentIndex = (currentIndex + 1) % mediaItems.length;
            openLightbox(mediaItems[currentIndex]);
          }
        });

        /* ===== Floating Navigation ===== */
        function initFloatingNav() {
          const floatingNav = document.querySelector(".floating-nav");
          const navItems = document.querySelectorAll(
            ".floating-nav-item:not(.floating-nav-overflow)",
          );
          const activeBg = document.querySelector(".floating-nav-active-bg");
          const overflowBtn = document.querySelector(".floating-nav-overflow");
          const overflowMenu = document.querySelector(
            ".floating-nav-overflow-menu",
          );

          if (!floatingNav) return;

          // Move active background to specific item
          function moveActiveBgTo(activeItem) {
            const pill = document.querySelector(".floating-nav-pill");
            const bg = pill.querySelector(".floating-nav-active-bg");
            const x =
              activeItem.offsetLeft +
              (activeItem.offsetWidth - bg.offsetWidth) / 2;
            bg.style.transform = `translateX(${Math.round(x)}px)`;
          }

          // Set active state and move background
          function setActiveNav(page) {
            navItems.forEach((item) => {
              const itemPage = item.getAttribute("data-page");
              if (itemPage === page) {
                item.classList.add("active");
                moveActiveBgTo(item);
              } else {
                item.classList.remove("active");
              }
            });
          }

          // Handle overflow menu
          if (overflowBtn && overflowMenu) {
            overflowBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              overflowMenu.classList.toggle("show");
            });

            // Close overflow menu when clicking outside
            document.addEventListener("click", (e) => {
              if (!overflowBtn.contains(e.target)) {
                overflowMenu.classList.remove("show");
              }
            });

            // Close overflow menu when clicking an item
            document
              .querySelectorAll(".floating-nav-overflow-item")
              .forEach((item) => {
                item.addEventListener("click", () => {
                  overflowMenu.classList.remove("show");
                });
              });
          }

          // Update active state when page changes
          window.updateFloatingNav = setActiveNav;
        }

        function recalcFloatingNavBg() {
          const pill = document.querySelector(".floating-nav-pill");
          const bg = pill?.querySelector(".floating-nav-active-bg");
          const activeItem =
            document.querySelector(".floating-nav-item.active") ||
            document.querySelector('.floating-nav-item[data-page="home"]');
          if (!pill || !bg || !activeItem) return;

          // If you want the first position jump to be instant, briefly disable transition:
          const prev = bg.style.transition;
          bg.style.transition = "none";
          // let layout settle, then move
          requestAnimationFrame(() => {
            const x =
              activeItem.offsetLeft +
              (activeItem.offsetWidth - bg.offsetWidth) / 2;
            bg.style.transform = `translateX(${Math.round(x)}px)`;
            // restore transition for future moves
            requestAnimationFrame(() => (bg.style.transition = prev || ""));
          });
        }

        // after you update the floating nav on page changes:
        const originalLoadPage = loadPage;
        loadPage = function (page) {
          originalLoadPage(page);
          // Reset scroll position to top when navigating between pages
          window.scrollTo(0, 0);
          if (window.updateFloatingNav) window.updateFloatingNav(page);
          recalcFloatingNavBg();
        };

        // on resize and breakpoint changes:
        const mq = window.matchMedia("(max-width:700px)");
        mq.addEventListener?.("change", () => {
          // when pill switches between display:none/block
          if (mq.matches) setTimeout(recalcFloatingNavBg, 0);
        });
        window.addEventListener("resize", () => {
          // debounce if you like; simple is fine here
          recalcFloatingNavBg();
        });

        // when icon fonts finish loading:
        if (document.fonts?.ready) {
          document.fonts.ready.then(recalcFloatingNavBg);
        }

        // (nice-to-have) if you want rock-solid behavior on any layout change:
        new ResizeObserver(recalcFloatingNavBg).observe(
          document.querySelector(".floating-nav-pill"),
        );

        window.addEventListener("scroll", handleScroll, {
          passive: true,
        });
        handleScroll(); // initialize state on load/restore
        /* Boot */
        initFloatingNav();
        recalcFloatingNavBg();
        updateNavigation(); // Set initial navigation state
        loadPage("home");

        // Make functions globally accessible for inline onclick handlers
        window.loadPage = loadPage;
        window.logout = logout;
        window.updateNavigation = updateNavigation;
      });
    </script>
  </body>
</html>
